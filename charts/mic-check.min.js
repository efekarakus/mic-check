function comms(){function objectiveControl(){var players=g.players;players.selectAll(".time").transition().delay(0).duration(0).attr("opacity",0),svg.select("g.top.axis").transition().duration(0).attr("opacity",0),svg.select("g.bot.axis").transition().duration(0).attr("opacity",0),svg.select("g.top.zoom.axis").transition().duration(500).attr("opacity",1),svg.select("g.bot.zoom.axis").transition().duration(500).attr("opacity",1),svg.selectAll(".timeline").transition().duration(500).attr("opacity",1),players.selectAll(".strip").transition().duration(0).attr("opacity",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?1:0}),players.selectAll(".strip").transition("objective-control").duration(800).attr("x",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?zoomX(d.start):d.transition}).attr("width",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?zoomX(d.end)-zoomX(d.start):x(d.end)-x(d.start)}),players.selectAll(".overlap").transition().duration(0).attr("opacity",0),players.selectAll(".overlap").transition().delay(800).duration(0).attr("x",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?zoomX(d.start):x(d.start)}).attr("width",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?zoomX(d.end)-zoomX(d.start):x(d.end)-x(d.start)}).attr("opacity",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?1:0})}function interruptions(){svg.select("g.top.zoom.axis").transition().duration(0).attr("opacity",0),svg.select("g.bot.zoom.axis").transition().duration(0).attr("opacity",0),svg.selectAll(".timeline").transition().duration(500).attr("opacity",0),svg.select("g.top.axis").transition().duration(500).attr("opacity",1),svg.select("g.bot.axis").transition().duration(500).attr("opacity",1);var players=g.players;players.selectAll(".strip").transition("objective-control").duration(800).attr("x",function(d){return x(d.start)}).attr("width",function(d){return x(d.end)-x(d.start)}).attr("opacity",1),players.selectAll(".overlap").transition().delay(0).duration(0).attr("opacity",0),players.selectAll(".overlap").transition().delay(800).duration(0).attr("x",function(d){return x(d.start)}).attr("width",function(d){return x(d.end)-x(d.start)}).attr("opacity",1)}function conclusion(){}function setupSections(){activateFunctions[0]=communication,activateFunctions[1]=distribution,activateFunctions[2]=objectiveControl,activateFunctions[3]=interruptions,activateFunctions[4]=conclusion}function overlap(a,b){for(var duration=a.length,overlap=[],second=0;duration>second;second+=1){var ai=a[second],bi=b[second];1===ai&&1===bi?overlap.push(1):overlap.push(0)}return overlap}function allOverlaps(a,b,c){for(var duration=a.length,overlap=0,clear=0,second=0;duration>second;second+=1){var ai=a[second],bi=b[second],ci=c[second];1===ai&&1===bi?overlap+=1:1===ai&&1===ci?overlap+=1:1===ai&&0===bi&&0===ci&&(clear+=1)}console.log(overlap,clear)}function reduce(seconds){for(var bars=[],index=0;index<seconds.length;){var speech=1===seconds[index]?!0:!1;if(speech){for(var window=index+1;window<seconds.length;){var nextSpeech=1===seconds[window]?!0:!1;if(!nextSpeech){bars.push({start:index,end:window});break}window+=1}index=window}else index+=1}return bars}function stack(bars){var sum=0;return bars.forEach(function(bar,index){bar.transition=sum,sum+=x(bar.end)-x(bar.start)}),bars}var attributes={};attributes.svg={width:830,height:600,translate:{x:0,y:0}},attributes.legends={width:100},attributes.players={width:700,height:107,margin:{top:30,left:0,bottom:30,right:0}},attributes.axes={width:700},attributes.legends.top={height:50,translate:{x:0,y:0}},attributes.legends.players={translate:{x:0,y:function(i){var offset=attributes.legends.top.height,height=attributes.players.height+attributes.players.margin.top+attributes.players.margin.bottom;return offset+i*height}}},attributes.legends.bottom={height:50,translate:{x:0,y:550}},attributes.players.translate={x:attributes.legends.width,y:function(i){var offset=attributes.legends.top.height,height=attributes.players.height+attributes.players.margin.top+attributes.players.margin.bottom;return offset+i*height}},attributes.axes.top={translate:{x:attributes.legends.width,y:attributes.legends.top.height}},attributes.axes.bottom={translate:{x:attributes.legends.width,y:550}};var timeline=[{time:1743,killer:"Ashe",victim:"Zilean",assists:[]},{time:1746,killer:"Hecarim",victim:"Baron",assists:[]},{time:1800,killer:"Fiora",victim:"Yasuo",assists:["Sivir","Hecarim","Braum"]},{time:1803,killer:"Hecarim",victim:"Nami",assists:["Braum"]},{time:1828,killer:"Zilean",victim:"Tower",assists:[]},{time:1843,killer:"Zilean",victim:"Tower",assits:[]},{time:1848,killer:"Zilean",victim:"Inhibitor",assists:[]},{time:1872,killer:"Hecarim",victim:"Dragon",assists:[]}],gameLength=2225,zoomTimes={start:1740,end:1920},previousSection=-1,currentSection=0,activateFunctions=[],svg=void 0,g={},x=d3.scale.linear().domain([0,gameLength]).range([0,attributes.players.width]),zoomX=d3.scale.linear().domain([zoomTimes.start,zoomTimes.end]).range([0,attributes.players.width]),chart=function(selection){selection.each(function(data){data.forEach(function(d){d.sum=d.seconds.reduce(function(a,b){return a+b})}),console.log("Top"),allOverlaps(data[0].seconds,data[1].seconds,data[2].seconds),console.log("Jungle"),allOverlaps(data[1].seconds,data[0].seconds,data[2].seconds),console.log("Mid"),allOverlaps(data[2].seconds,data[0].seconds,data[1].seconds),svg=d3.select(this).append("svg").attr("width",attributes.svg.width).attr("height",attributes.svg.height);var players=svg.selectAll(".players").data(data).enter().append("g").attr("transform",function(d,i){var translate=attributes.players.translate,margin=attributes.players.margin;return"translate("+(translate.x+margin.left)+","+(translate.y(i)+margin.top)+")"}).attr("class","players").attr("id",function(d){return d.position});players.append("rect").attr("x",0).attr("y",0).attr("width",attributes.players.width).attr("height",attributes.players.height).attr("class","bounding-box"),players.selectAll(".strip").data(function(d){return stack(reduce(d.seconds))}).enter().append("rect").attr("x",function(d){return x(d.start)}).attr("y",0).attr("width",function(d){return x(d.end)-x(d.start)}).attr("height",attributes.players.height).attr("class","strip"),players.append("g").attr("class","time").attr("opacity",0).append("text").text(function(d){var minutes=Math.floor(d.sum/60),seconds=d.sum%60,percentage=Math.round(d.sum/gameLength*1e3)/10;return minutes+":"+seconds+" ("+percentage+"%)"}).attr("x",function(d){return x(d.sum)+20}).attr("y",attributes.players.height/2).attr("dy","15px").attr("font-family","BigNoodle").attr("font-size","60px");var topAndJungle=overlap(data[0].seconds,data[1].seconds),topAndMid=overlap(data[0].seconds,data[2].seconds),jungleAndMid=overlap(data[1].seconds,data[2].seconds);[d3.select("#Top"),d3.select("#Jungle")].forEach(function(selection){selection.selectAll(".top-jungle-overlap").data(reduce(topAndJungle)).enter().append("rect").attr("x",function(d){return x(d.start)}).attr("y",2).attr("width",function(d){return x(d.end)-x(d.start)}).attr("height",attributes.players.height-2).attr("class","overlap").attr("fill","#CD0A6C").style("stroke","1").style("stroke","#CD0A6C").attr("opacity",0)}),[d3.select("#Top"),d3.select("#Mid")].forEach(function(selection){selection.selectAll(".top-mid-overlap").data(reduce(topAndMid)).enter().append("rect").attr("x",function(d){return x(d.start)}).attr("y",2).attr("width",function(d){return x(d.end)-x(d.start)}).attr("height",attributes.players.height-2).attr("class","overlap").attr("fill","#CD0A6C").style("stroke","1").style("stroke","#CD0A6C").attr("opacity",0)}),[d3.select("#Jungle"),d3.select("#Mid")].forEach(function(selection){selection.selectAll(".jungle-mid-overlap").data(reduce(jungleAndMid)).enter().append("rect").attr("x",function(d){return x(d.start)}).attr("y",2).attr("width",function(d){return x(d.end)-x(d.start)}).attr("height",attributes.players.height-2).attr("class","overlap").attr("fill","#CD0A6C").style("stroke","1").style("stroke","#CD0A6C").attr("opacity",0)});var axis=d3.svg.axis().scale(x).tickValues(d3.range(0,gameLength+1).filter(function(d,i){return d%120===0||i===gameLength})).tickFormat(function(d){var minutes=Math.floor(d/60);10>minutes&&(minutes="0"+minutes);var seconds=d%60;return 10>seconds&&(seconds="0"+seconds),minutes+":"+seconds}).orient("top"),topAxis=svg.append("g").attr("transform","translate("+attributes.axes.top.translate.x+", "+attributes.axes.top.translate.y+")").attr("class","top axis").call(axis).selectAll("text").attr("dx",function(d){return d===gameLength?".85em":"0em"}).attr("transform","rotate(-10)");axis.orient("bottom");var botAxis=svg.append("g").attr("transform","translate("+attributes.axes.bottom.translate.x+", "+attributes.axes.bottom.translate.y+")").attr("class","bot axis").call(axis).selectAll("text").attr("dx",function(d){return d===gameLength?".85em":"0em"}).attr("transform","rotate(10)"),zoomAxis=d3.svg.axis().scale(zoomX).tickValues(d3.range(zoomTimes.start,zoomTimes.end+1).filter(function(d,i){return d%10===0||i===gameLength})).tickFormat(function(d){var minutes=Math.floor(d/60);10>minutes&&(minutes="0"+minutes);var seconds=d%60;return 10>seconds&&(seconds="0"+seconds),minutes+":"+seconds}).orient("top"),topZoomAxis=svg.append("g").attr("transform","translate("+attributes.axes.top.translate.x+", "+attributes.axes.top.translate.y+")").attr("class","top zoom axis").attr("opacity",0).call(zoomAxis).selectAll("text").attr("dx",function(d){return d===zoomTimes.end?".85em":"0em"});zoomAxis.orient("bottom");var botZoomAxis=svg.append("g").attr("transform","translate("+attributes.axes.bottom.translate.x+", "+attributes.axes.bottom.translate.y+")").attr("class","bot zoom axis").attr("opacity",0).call(zoomAxis).selectAll("text").attr("dx",function(d){return d===zoomTimes.end?".85em":"0em"}),timelineEvents=svg.selectAll(".timeline").data(timeline).enter().append("g").attr("transform",function(d,i){return i%2===0?"translate("+(attributes.axes.top.translate.x+zoomX(d.time)-19)+", 0)":"translate("+(attributes.axes.top.translate.x+zoomX(d.time)-19)+", "+(attributes.svg.height-20)+")"}).attr("class","timeline").attr("opacity",0);timelineEvents.append("image").attr("xlink:href",function(d){return"images/"+d.killer+".png"}).attr("x",0).attr("y",0).attr("height","19px").attr("width","19px"),timelineEvents.append("image").attr("xlink:href",function(d){return"images/kill.png"}).attr("x",19).attr("y",0).attr("height","19px").attr("width","19px"),timelineEvents.append("image").attr("xlink:href",function(d){return"images/"+d.victim+".png"}).attr("x",38).attr("y",0).attr("height","19px").attr("width","19px");var playerLegend=svg.selectAll(".player-legend").data(data).enter().append("g").attr("transform",function(d,i){var translate=attributes.legends.players.translate,x=translate.x,y=translate.y(i);return"translate("+x+","+y+")"});playerLegend.append("text").text(function(d){return d.position}).attr("x",70).attr("y",70).attr("text-anchor","middle").attr("dy","-6px").attr("font-family","BigNoodle"),playerLegend.append("image").attr("xlink:href",function(d){return"images/"+d.champion+".png"}).attr("x",50).attr("y",70).attr("height","40px").attr("width","40px"),g.players=players,g.axes={top:topAxis,bot:botAxis,zoom:{top:topZoomAxis,bot:botZoomAxis}},g.legends={players:playerLegend},setupSections()})};chart.activate=function(index){currentSection=index;var sign=0>currentSection-previousSection?-1:1,scrolledSections=d3.range(previousSection+sign,currentSection+sign,sign);scrolledSections.forEach(function(i){activateFunctions[i]()}),previousSection=currentSection},chart.play=function(){if(0===currentSection){var button=d3.select(".btn");button.select("span").text("stop"),button.attr("action","pause"),topAudio.play(),jungleAudio.play(),midAudio.play();var players=g.players;players.selectAll(".strip").transition("audioplay").delay(function(d){return 1e3*d.start}).attr("y",2).attr("height",attributes.players.height-4).style("fill","#CD0A6C").style("stroke","#CD0A6C").style("stroke-width","4"),players.selectAll(".strip").transition("audiostop").delay(function(d){return 1e3*d.end}).attr("y",0).attr("height",attributes.players.height).style("fill","#000").style("stroke","#000").style("stroke-width","0")}},chart.stop=function(){var button=d3.select(".btn");button.select("span").text("play"),button.attr("action","play"),topAudio.pause(),jungleAudio.pause(),midAudio.pause(),topAudio.currentTime=audioStart.top,jungleAudio.currentTime=audioStart.jungle,midAudio.currentTime=audioStart.mid;var players=g.players;players.selectAll(".strip").transition("audioplay").duration(0).style("fill","#000").style("stroke","#000").style("stroke-width","0"),players.selectAll(".strip").transition("audiostop").duration(0)};var communication=function(){var players=g.players;previousSection>0&&(players.selectAll(".time").transition().delay(0).duration(0).attr("opacity",0),players.selectAll(".strip").transition("distribution-placement").duration(0).attr("x",function(d){return d.transition}).attr("width",function(d){return x(d.end)-x(d.start)}).attr("opacity",1)),players.selectAll(".strip").transition().duration(600).attr("x",function(d){return x(d.start)})},distribution=function(){var players=g.players;chart.stop(),players.selectAll(".strip").transition().duration(0).attr("x",function(d){return x(d.start)}),previousSection>=2&&(svg.select("g.top.zoom.axis").transition().duration(0).attr("opacity",0),svg.select("g.bot.zoom.axis").transition().duration(0).attr("opacity",0),svg.select("g.top.axis").transition().duration(500).attr("opacity",1),svg.select("g.bot.axis").transition().duration(500).attr("opacity",1),svg.selectAll(".timeline").transition().duration(500).attr("opacity",0),players.selectAll(".strip").transition("objective-control").duration(0).attr("x",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?zoomX(d.start):d.transition}).attr("width",function(d){return d.start>=zoomTimes.start&&d.end<=zoomTimes.end?zoomX(d.end)-zoomX(d.start):x(d.end)-x(d.start)}),players.selectAll(".overlap").transition().delay(0).duration(0).attr("width",function(d){return x(d.end)-x(d.start)}).attr("x",function(d){return x(d.start)}).attr("opacity",0)),players.selectAll(".strip").transition().duration(800).attr("x",function(d){return d.transition}).attr("width",function(d){return x(d.end)-x(d.start)}).attr("opacity",1),players.selectAll(".time").transition().delay(800).duration(200).attr("opacity",1)};return chart}function distribution(){var margin={top:20,right:5,bottom:50,left:20},width=220-margin.left-margin.right,height=220-margin.top-margin.bottom,data=[{bucket:"[0 - 10)",duration:62},{bucket:"[10 - 20)",duration:81},{bucket:"[20 - 30)",duration:87},{bucket:"[30 - end]",duration:115}],x=d3.scale.ordinal().domain(data.map(function(d){return d.bucket})).rangeRoundBands([0,width]),y=d3.scale.linear().domain([0,d3.max(data,function(d){return d.duration})]).range([height,0]),xAxis=d3.svg.axis().scale(x).orient("bottom"),svg=(d3.svg.axis().scale(y).tickValues([]).orient("left"),d3.select(".fiora-distribution").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"));svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),svg.append("g").append("text").attr("transform","rotate(-90)").attr("y",9).attr("dy","-20px").style("text-anchor","end").style("font","12px sans-serif").text("duration (s)"),svg.append("g").append("text").attr("x",width/2).attr("y",height).attr("dy","45px").style("text-anchor","middle").style("font","12px sans-serif").style("text-decoration","underline").text("Fiora's Speech Distribution"),svg.selectAll(".bar").data(data).enter().append("rect").attr("x",function(d){return x(d.bucket)}).attr("width",x.rangeBand()-5).attr("y",function(d){return y(d.duration)}).attr("height",function(d){return height-y(d.duration)}).style("stroke","black").style("stroke-width",1).style("fill","#CD0A6C"),svg.selectAll(".duration").data(data).enter().append("text").attr("x",function(d){return x(d.bucket)}).attr("y",function(d){return y(d.duration)}).attr("dx","13px").attr("dy","-10px").style("font","12px sans-serif").text(function(d){return d.duration})}function legend(){var margin={top:0,right:0,bottom:0,left:0},width=220-margin.left-margin.right,height=220-margin.top-margin.bottom,svg=d3.select(".objectivecontrol-legend").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");svg.append("text").attr("x",0).attr("y","20px").style("font","12px sans-serif").style("text-decoration","underline").text("Legend"),svg.append("line").attr("x1",0).attr("x2",40).attr("y1",50).attr("y2",50).style("stroke","#CD0A6C").style("stroke-width",3),svg.append("text").attr("x",60).attr("y",50).attr("dy","4px").style("font","12px sans-serif").text("Interruption");var data=[{path:"kill.png",text:"Kill"},{path:"Tower.png",text:"Tower"},{path:"Inhibitor.png",text:"Inhibitor"},{path:"Baron.png",text:"Baron"},{path:"Dragon.png",text:"Dragon"}],g=svg.selectAll(".images").data(data).enter().append("g");g.append("image").attr("xlink:href",function(d){return"images/"+d.path}).attr("x",5).attr("y",function(d,i){return 30*i+70}).attr("width","19px").attr("height","19px"),g.append("text").attr("x",60).attr("y",function(d,i){return 30*i+70}).attr("dy","12px").style("font","12px sans-serif").text(function(d){return d.text})}function display(error,top,jungle,mid){var plot=comms();d3.select(".vis").datum([top,jungle,mid]).call(plot);var steps=d3.selectAll(".step"),scroll=scroller().container(d3.select(".graphic"));scroll(steps),scroll.on("active",function(index){steps.style("opacity",function(d,i){return i===index?1:.1}),plot.activate(index)}),d3.select(".btn").on("click",function(){var action=d3.select(this).attr("action");"play"===action?plot.play():plot.stop()})}distribution(),legend();var audioStart={top:114,jungle:196,mid:119},topAudio=new Audio("./data/audio/Top.mp3");topAudio.currentTime+=audioStart.top,topAudio.volume=.5;var jungleAudio=new Audio("./data/audio/Jungle.mp3");jungleAudio.currentTime+=audioStart.jungle;var midAudio=new Audio("./data/audio/Mid.mp3");midAudio.currentTime+=audioStart.mid,queue().defer(d3.json,"data/top.json").defer(d3.json,"data/jungle.json").defer(d3.json,"data/mid.json").await(display);
